import{m as Y,c as y,g as H,s as b,a as M,b as S,d as L,i as W,e as U,r as V,C as $,f as q,h as z,j as J,k as C,l as T,o as K,n as Q,G as X,p as R,q as O,t as B,u as A,v as k,w as D,x as N,y as h,F as Z,z as ee,A as ae,B as te,D as se,E as ne,H as re,_ as le}from"./index-cb278cdc.js";var ie=()=>{const n=Y();let e=y();const w=()=>{var a,t,s,r;return((t=(a=e.players)==null?void 0:a.red)==null?void 0:t.isReady)&&((r=(s=e.players)==null?void 0:s.black)==null?void 0:r.isReady)},E=a=>{var t,s;return((s=(t=e.players)==null?void 0:t[e.currentCamp])==null?void 0:s.id)===a.id},v=a=>{var t,s,r,u;return((s=(t=e.players)==null?void 0:t.red)==null?void 0:s.id)===a.id?"red":((u=(r=e.players)==null?void 0:r.black)==null?void 0:u.id)===a.id?"black":null},p=(a,t)=>{const{activePiece:s,chessPieces:r}=e,u=S(a,r);u&&(e.chessPieces=r.filter(f=>f!==u),n.emit("piece:kill",{piece:s,targetPiece:u})),e.manual.push(V(s,a,r)),e.movePath=[e.activePiece.coord,a],$.move(s,a),n.emit("piece:move",{piece:s,targetPoint:a}),e.message=t==="check"?[{type:"animation",content:"check"}]:[];const m=q(e.currentCamp,r);if(m){e.message.push({type:"animation",content:"checkMate"},{type:"animation",content:e.currentCamp==="black"?"blackWin":"redWin"}),e.status="FINISHED",e.players.red.isReady=!1,e.players.black.isReady=!1,e.allowPoints=[],n.emit("game:over",e);return}Object.assign(e,{currentCamp:m?e.currentCamp:b(e.currentCamp),allowPoints:[],activePiece:null}),n.emit("context:change",{context:e})},o=a=>{var t,s,r;return(t=e.players)!=null&&t.red&&((s=e.players)!=null&&s.black)?!1:((r=e.players)!=null&&r.red?e.players.black=a:e.players={red:a},n.emit("player:join",a),e.status!=="INIT"&&Object.assign(e,y(),{status:"INIT",players:e.players,firstCamp:"red",currentCamp:"red"}),n.emit("context:change",{context:e}),!0)},c=a=>{var t,s,r,u,m,f,G,j;((s=(t=e.players)==null?void 0:t.black)==null?void 0:s.id)===a.id?e.players.black=void 0:((u=(r=e.players)==null?void 0:r.red)==null?void 0:u.id)===a.id&&(e.players.red=void 0),n.emit("player:leave",a),!((m=e.players)!=null&&m.black)&&!((f=e.players)!=null&&f.red)?(e=y(),n.emit("game:over",e)):((G=e.players)!=null&&G.black||(j=e.players)!=null&&j.red)&&(e=y(e.players),n.emit("game:reset",e))},l=(a,t,s="red")=>{var r,u,m,f;((u=(r=e.players)==null?void 0:r.black)==null?void 0:u.id)===a.id?(e.players.black.isReady=t,e.players.black.firstCamp=s,n.emit(t?"player:ready":"player:cancel:ready",a)):((f=(m=e.players)==null?void 0:m.red)==null?void 0:f.id)===a.id&&(e.players.red.isReady=t,e.players.red.firstCamp=s,n.emit(t?"player:ready":"player:cancel:ready",a)),n.emit("context:change",{context:e})},g=()=>{e.status!=="INIT"&&e.status!=="FINISHED"||!e.players||([e.players.red,e.players.black]=[e.players.black,e.players.red],e.message=[{type:"tips",content:"双方交换阵营"}],n.emit("player:switch:camp",e))},P=a=>{if(e.status!=="PLAYING"||!e.players)return;const t=e.manual.at(-1);if(!t)return;const s=t.camp===a?e.manual.slice(0,-1):e.manual.slice(0,-2);Object.assign(e,{...e,...H(s),manual:s,currentCamp:b(e.currentCamp),activePiece:null,allowPoints:[],movePath:[],message:[]}),n.emit("game:undo",e)},d=()=>{if(!w())return!1;const a=M(e.players);return Object.assign(e,{status:"PLAYING",firstCamp:a,currentCamp:a}),n.emit("game:start",e),!0},_=()=>{if(!w())return!1;const a=M(e.players);return Object.assign(e,y(),{status:"PLAYING",players:e.players,firstCamp:a,currentCamp:a}),n.emit("game:start",e),!0},x=(a=!0)=>{e.status=a?"PAUSED":"PLAYING",n.emit("game:pause"),n.emit("context:change",{context:e})},F=(a,t)=>{if(!E(a))return e.message=[{type:"tips",content:"非当前阵营用户操作"}],n.emit("game:error",{context:e,user:a}),!1;const s=S(t,e.chessPieces);if(!e.activePiece)return s?e.currentCamp!==(s==null?void 0:s.camp)?(e.message=[{type:"tips",content:"无法选择对方的棋子"}],n.emit("game:error",{context:e,user:a}),!1):(e.activePiece=s,e.allowPoints=L(s,e.chessPieces),e.message=[],e.movePath=[],n.emit("piece:select",{context:e,user:a}),!0):(e.message=[{type:"tips",content:"无法选择空区域"}],n.emit("game:error",{context:e,user:a}),!1);if(e.currentCamp===(s==null?void 0:s.camp))return e.message=[],W(e.activePiece.coord,s.coord)?(e.activePiece=null,e.allowPoints=[],n.emit("piece:select:cancel",{context:e,user:a})):(e.activePiece=s,e.allowPoints=L(s,e.chessPieces),n.emit("piece:select",{context:e,user:a})),!0;if(!e.allowPoints.find(u=>W(u,t)))return e.message=[{type:"tips",content:"当前位置无法移动"}],e.activePiece=null,e.allowPoints=[],n.emit("game:error",{context:e,user:a}),!1;const r=U(e.activePiece,t,e.chessPieces);switch(r){case"allow":return p(t,r),!0;case"not-allow":return e.message=[{type:"tips",content:"当前位置无法移动"}],e.activePiece=null,e.allowPoints=[],n.emit("game:error",{context:e,user:a}),!1;case"check":return p(t,r),!0;default:return!1}},I=a=>{if(e.status!=="PLAYING")return;const t=v(a);t&&(e.players.red.isReady=!1,e.players.black.isReady=!1,Object.assign(e,{status:"FINISHED",message:[{type:"tips",content:`用户「${e.players[t].nickname}」投降了`}],allowPoints:[],activePiece:null}),n.emit("game:give:up",e))},i=()=>{e=y(),n.all.clear(),n.emit("context:change",{context:e})};return{get context(){return e},on:n.on,join:o,leave:c,readyOrCancelReady:l,exchangePlayersCamp:g,start:d,restart:_,pauseOrPlay:x,moveOrSelect:F,undo:P,giveUp:I,reset:i}};const ce={class:"offline-game"},oe={class:"header"},ue={class:"list manual-list"},me=z({__name:"OfflineGame",emits:["update:mode"],setup(n,{emit:e}){const w=e,E=J("resources",C({})),v=C(null),p=C(!1),o=ie(),c=C(null),l=C(null),g={id:"1",nickname:"用户A",firstCamp:T.RED,isReady:!1},P={id:"2",nickname:"用户B",firstCamp:T.RED,isReady:!1};o.join(g),o.join(P),K(()=>{v.value&&(o.readyOrCancelReady(g,!0),o.readyOrCancelReady(P,!0),l.value=Q(E.value),l.value.mount(v.value),l.value.mainCanvas.addEventListener("click",i=>{o.moveOrSelect(o.context.players[o.context.currentCamp],l.value.getPointer(i))}),l.value.on("animation:finished",i=>{var a;if(i!=="win"&&((a=l.value)==null||a.animations.clear()),c.value.message.length>0){const t=c.value.message.shift();t.type==="animation"?_(t.content):t.type==="tips"&&x(t.content)}}),o.on("game:start",i=>{d(i)}),o.on("game:restart",()=>{d(o.context)}),o.on("context:change",({context:i})=>{d(i)}),o.on("piece:select",({context:i})=>{d(i)}),o.on("piece:select:cancel",({context:i})=>{d(i)}),o.on("game:over",i=>{d(i)}),o.start())});const d=i=>{if(c.value=i,l.value){if(l.value.clearAll(),l.value.drawChessPieces(c.value.chessPieces),c.value.activePiece?(l.value.activePieceAnimation.stop(),l.value.activePieceAnimation.run(c.value.activePiece)):l.value.activePieceAnimation.stop(),c.value.allowPoints&&l.value.drawAllowPoints(c.value.allowPoints),c.value.movePath.length>0&&(console.log(b(c.value.currentCamp)),l.value.drawCurrentStop(c.value.movePath.at(-1),b(c.value.currentCamp)),l.value.drawLastStop(c.value.movePath[0],b(c.value.currentCamp))),c.value.message.length>0){const a=c.value.message.shift();a.type==="animation"?_(a.content):a.type==="tips"&&x(a.content)}c.value.status===X.Finished&&(console.log(c.value.manual),R.info("游戏结束"))}},_=i=>{if(l.value)switch(i){case"check":l.value.animations.check.run();break;case"checkMate":l.value.animations.checkMate.run();break;case"blackWin":l.value.animations.blackWin.run();break;case"redWin":l.value.animations.redWin.run();break}},x=i=>{R.destroy(),R.info(i)},F=()=>{o.readyOrCancelReady(g,!0),o.readyOrCancelReady(P,!0),o.restart()},I=()=>{w("update:mode",null)};return(i,a)=>{const t=ne,s=re;return O(),B("div",ce,[A("header",oe,[k(t,{onClick:I},{default:D(()=>a[2]||(a[2]=[N(" 退出 ")])),_:1}),a[5]||(a[5]=A("h1",{class:"title"},"OFFLINE",-1)),k(t,{class:"btn-restart",onClick:F},{default:D(()=>a[3]||(a[3]=[N(" 重新开始 ")])),_:1}),k(t,{type:h(p)?"primary":"dashed",onClick:a[0]||(a[0]=r=>p.value=!h(p))},{default:D(()=>a[4]||(a[4]=[N(" 查看棋谱 ")])),_:1},8,["type"])]),A("div",{ref_key:"offlineMainRef",ref:v,class:"offline-game-container"},null,512),k(se,{open:h(p),"onUpdate:open":a[1]||(a[1]=r=>te(p)?p.value=r:null),title:"棋谱",class:"drawer",width:"80%"},{default:D(()=>{var r;return[A("ul",ue,[(O(!0),B(Z,null,ee(((r=h(c))==null?void 0:r.manual)??[],(u,m)=>(O(),B("li",{key:u.value+u.camp+m,class:"manual-item"},[k(s,{color:h(ae)[u.camp],text:`[${m+1}] ${u.value}`},null,8,["color","text"])]))),128))])]}),_:1},8,["open"])])}}});const de=le(me,[["__scopeId","data-v-d7438350"]]);export{de as default};
